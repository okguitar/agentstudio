## ğŸ¯ è®¾è®¡ç›®æ ‡

å®ç°ä¸€ä¸ªè½»é‡çº§ã€å¯é çš„æ™ºèƒ½æ ‡ç­¾é¡µç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒæ‰€æœ‰URLæ‰“å¼€æ–¹å¼çš„å…¼å®¹æ€§ï¼š
- ä»ªè¡¨æ¿æ°”æ³¡æŒ‰é’®ç‚¹å‡»
- ç›´æ¥URLåœ°å€æ è¾“å…¥
- ä¹¦ç­¾æ‰“å¼€
- å¤–éƒ¨é“¾æ¥è·³è½¬
- æµè§ˆå™¨å†å²è®°å½•
- æ–°çª—å£/æ–°æ ‡ç­¾é¡µæ‰“å¼€

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TabManager (æ ¸å¿ƒç®¡ç†å™¨)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ localStorage æŒä¹…åŒ–å­˜å‚¨                                   â”‚
â”‚  â€¢ æ ‡ç­¾é¡µæ³¨å†Œ/æ³¨é”€                                          â”‚
â”‚  â€¢ å”¤èµ·ä¿¡å·å‘é€/æ¥æ”¶                                        â”‚
â”‚  â€¢ è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ ‡ç­¾é¡µ                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                      â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SessionsDashboardâ”‚    â”‚   ChatPage       â”‚   â”‚  SmartNavigation â”‚
â”‚   (è§¦å‘ç«¯)        â”‚    â”‚  (ç›®æ ‡ç«¯)         â”‚   â”‚    (å·¥å…·åº“)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ£€æµ‹å·²å­˜åœ¨æ ‡ç­¾é¡µ â”‚    â”‚ â€¢ è‡ªåŠ¨æ³¨å†Œæ ‡ç­¾é¡µ   â”‚   â”‚ â€¢ æ™ºèƒ½è·¯ç”±å†³ç­–    â”‚
â”‚ â€¢ å‘é€å”¤èµ·ä¿¡å·    â”‚    â”‚ â€¢ ç›‘å¬å”¤èµ·ä¿¡å·    â”‚   â”‚ â€¢ é™çº§å¤„ç†æœºåˆ¶    â”‚
â”‚ â€¢ æ™ºèƒ½æ‰“å¼€/å”¤èµ·   â”‚    â”‚ â€¢ å“åº”èšç„¦è¯·æ±‚    â”‚   â”‚ â€¢ ç»Ÿä¸€APIæ¥å£     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ æ–‡ä»¶ç»“æ„å’Œæ”¹åŠ¨

### æ–°å¢æ–‡ä»¶

#### 1. `frontend/src/utils/tabManager.ts` (æ ¸å¿ƒç®¡ç†å™¨)
```typescript
/**
 * æ™ºèƒ½æ ‡ç­¾é¡µç®¡ç†å™¨ - æ ¸å¿ƒå®ç°
 */

interface TabInfo {
  agentId: string;
  sessionId: string;
  url: string;
  lastSeen: number;
  tabId: string;
  title: string;
}

interface WakeupSignal {
  type: 'WAKEUP';
  agentId: string;
  sessionId: string;
  requestId: string;
  timestamp: number;
  sourceUrl: string;
}

interface WakeupResponse {
  requestId: string;
  agentId: string;
  sessionId: string;
  success: boolean;
  timestamp: number;
}

export class TabManager {
  private static instance: TabManager;
  private static readonly STORAGE_KEY = 'active_chat_tabs';
  private static readonly WAKEUP_SIGNAL_KEY = 'tab_wakeup_signal';
  private static readonly WAKEUP_RESPONSE_KEY = 'tab_wakeup_response';
  private static readonly TAB_TIMEOUT = 5 * 60 * 1000; // 5åˆ†é’Ÿè¶…æ—¶
  
  private currentTabId: string;
  private cleanupInterval: number;
  
  private constructor() {
    this.currentTabId = this.generateTabId();
    this.startCleanupTimer();
    this.setupBeforeUnloadHandler();
  }
  
  static getInstance(): TabManager {
    if (!TabManager.instance) {
      TabManager.instance = new TabManager();
    }
    return TabManager.instance;
  }
  
  // ==================== æ ¸å¿ƒåŠŸèƒ½ ====================
  
  /**
   * æ³¨å†Œå½“å‰æ ‡ç­¾é¡µ
   */
  registerCurrentTab(agentId: string, sessionId: string): void {
    const tabs = this.getActiveTabs();
    const tabKey = this.getTabKey(agentId, sessionId);
    
    const tabInfo: TabInfo = {
      agentId,
      sessionId,
      url: window.location.href,
      lastSeen: Date.now(),
      tabId: this.currentTabId,
      title: document.title
    };
    
    tabs[tabKey] = tabInfo;
    this.saveActiveTabs(tabs);
    
    console.log(`ğŸ“± Tab registered: ${this.currentTabId} for session ${sessionId}`);
  }
  
  /**
   * æ›´æ–°å½“å‰æ ‡ç­¾é¡µæ´»è·ƒçŠ¶æ€
   */
  updateCurrentTabActivity(agentId: string, sessionId: string): void {
    const tabs = this.getActiveTabs();
    const tabKey = this.getTabKey(agentId, sessionId);
    
    if (tabs[tabKey] && tabs[tabKey].tabId === this.currentTabId) {
      tabs[tabKey].lastSeen = Date.now();
      tabs[tabKey].url = window.location.href;
      tabs[tabKey].title = document.title;
      this.saveActiveTabs(tabs);
    }
  }
  
  /**
   * æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒçš„æ ‡ç­¾é¡µ
   */
  hasActiveTab(agentId: string, sessionId: string): boolean {
    const tabs = this.getActiveTabs();
    const tabKey = this.getTabKey(agentId, sessionId);
    const tabInfo = tabs[tabKey];
    
    if (!tabInfo) return false;
    
    // æ£€æŸ¥æ˜¯å¦åœ¨è¶…æ—¶æ—¶é—´å†…
    const isActive = (Date.now() - tabInfo.lastSeen) < TabManager.TAB_TIMEOUT;
    
    if (!isActive) {
      // æ¸…ç†è¿‡æœŸæ ‡ç­¾é¡µ
      delete tabs[tabKey];
      this.saveActiveTabs(tabs);
    }
    
    return isActive;
  }
  
  /**
   * å”¤èµ·å·²å­˜åœ¨çš„æ ‡ç­¾é¡µ
   */
  async wakeupExistingTab(agentId: string, sessionId: string, targetUrl?: string): Promise<boolean> {
    if (!this.hasActiveTab(agentId, sessionId)) {
      return false;
    }
    
    const wakeupSignal: WakeupSignal = {
      type: 'WAKEUP',
      agentId,
      sessionId,
      requestId: this.generateRequestId(),
      timestamp: Date.now(),
      sourceUrl: targetUrl || window.location.href
    };
    
    // å‘é€å”¤èµ·ä¿¡å·
    localStorage.setItem(TabManager.WAKEUP_SIGNAL_KEY, JSON.stringify(wakeupSignal));
    
    // ç­‰å¾…å“åº”
    return new Promise((resolve) => {
      const timeoutId = setTimeout(() => {
        console.log(`â° Wakeup timeout for session ${sessionId}`);
        resolve(false);
      }, 2000);
      
      const checkResponse = () => {
        const responseStr = localStorage.getItem(TabManager.WAKEUP_RESPONSE_KEY);
        if (responseStr) {
          try {
            const response: WakeupResponse = JSON.parse(responseStr);
            if (response.requestId === wakeupSignal.requestId) {
              clearTimeout(timeoutId);
              localStorage.removeItem(TabManager.WAKEUP_RESPONSE_KEY);
              console.log(`âœ… Tab awakened successfully: ${sessionId}`);
              resolve(response.success);
              return;
            }
          } catch (e) {
            console.error('Error parsing wakeup response:', e);
          }
        }
      };
      
      // è½®è¯¢æ£€æŸ¥å“åº”
      const intervalId = setInterval(checkResponse, 100);
      setTimeout(() => clearInterval(intervalId), 2000);
    });
  }
  
  /**
   * ç›‘å¬å¹¶å“åº”å”¤èµ·ä¿¡å·
   */
  setupWakeupListener(agentId: string, sessionId: string): () => void {
    const handleStorageChange = (e: StorageEvent) => {
      if (e.key === TabManager.WAKEUP_SIGNAL_KEY && e.newValue) {
        try {
          const signal: WakeupSignal = JSON.parse(e.newValue);
          
          if (signal.type === 'WAKEUP' && 
              signal.agentId === agentId && 
              signal.sessionId === sessionId) {
            
            this.handleWakeupSignal(signal);
          }
        } catch (e) {
          console.error('Error handling wakeup signal:', e);
        }
      }
    };
    
    window.addEventListener('storage', handleStorageChange);
    
    // è¿”å›æ¸…ç†å‡½æ•°
    return () => window.removeEventListener('storage', handleStorageChange);
  }
  
  // ==================== ç§æœ‰æ–¹æ³• ====================
  
  private handleWakeupSignal(signal: WakeupSignal): void {
    console.log(`ğŸ”” Received wakeup signal for session: ${signal.sessionId}`);
    
    // 1. èšç„¦çª—å£
    window.focus();
    
    // 2. å¦‚æœé¡µé¢åœ¨åå°ï¼Œæ ‡é¢˜é—ªçƒæç¤º
    if (document.hidden) {
      this.flashPageTitle();
    }
    
    // 3. å¯é€‰ï¼šæ’­æ”¾æç¤ºéŸ³
    this.playNotificationSound();
    
    // 4. å¦‚æœURLä¸åŒï¼Œè¿›è¡Œå¯¼èˆª
    if (signal.sourceUrl && signal.sourceUrl !== window.location.href) {
      const url = new URL(signal.sourceUrl);
      if (url.pathname !== window.location.pathname || 
          url.search !== window.location.search) {
        window.history.replaceState(null, '', signal.sourceUrl);
        window.location.reload();
      }
    }
    
    // 5. å‘é€å“åº”
    const response: WakeupResponse = {
      requestId: signal.requestId,
      agentId: signal.agentId,
      sessionId: signal.sessionId,
      success: true,
      timestamp: Date.now()
    };
    
    localStorage.setItem(TabManager.WAKEUP_RESPONSE_KEY, JSON.stringify(response));
    
    // 6. æ¸…ç†ä¿¡å·
    localStorage.removeItem(TabManager.WAKEUP_SIGNAL_KEY);
    
    // 7. æ›´æ–°æ´»è·ƒçŠ¶æ€
    this.updateCurrentTabActivity(signal.agentId, signal.sessionId);
  }
  
  private flashPageTitle(): void {
    const originalTitle = document.title;
    let flashCount = 0;
    
    const flashInterval = setInterval(() => {
      document.title = flashCount % 2 === 0 ? 'ğŸ”” ä¼šè¯å·²å”¤èµ·' : originalTitle;
      flashCount++;
      
      if (flashCount > 6) { // é—ªçƒ3æ¬¡
        clearInterval(flashInterval);
        document.title = originalTitle;
      }
    }, 500);
    
    // é¡µé¢è·å¾—ç„¦ç‚¹æ—¶ç«‹å³åœæ­¢é—ªçƒ
    const stopFlashing = () => {
      clearInterval(flashInterval);
      document.title = originalTitle;
      window.removeEventListener('focus', stopFlashing);
    };
    
    window.addEventListener('focus', stopFlashing);
  }
  
  private playNotificationSound(): void {
    try {
      // ä½¿ç”¨ data URL åµŒå…¥ç®€å•çš„æç¤ºéŸ³
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj');
      audio.volume = 0.3;
      audio.play().catch(e => console.log('Audio play failed:', e));
    } catch (e) {
      console.log('Audio not supported:', e);
    }
  }
  
  private getActiveTabs(): Record<string, TabInfo> {
    try {
      const stored = localStorage.getItem(TabManager.STORAGE_KEY);
      return stored ? JSON.parse(stored) : {};
    } catch (e) {
      console.error('Error reading active tabs:', e);
      return {};
    }
  }
  
  private saveActiveTabs(tabs: Record<string, TabInfo>): void {
    try {
      localStorage.setItem(TabManager.STORAGE_KEY, JSON.stringify(tabs));
    } catch (e) {
      console.error('Error saving active tabs:', e);
    }
  }
  
  private getTabKey(agentId: string, sessionId: string): string {
    return `${agentId}_${sessionId}`;
  }
  
  private generateTabId(): string {
    return `tab_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  }
  
  private generateRequestId(): string {
    return `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  }
  
  private startCleanupTimer(): void {
    // æ¯åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡è¿‡æœŸæ ‡ç­¾é¡µ
    this.cleanupInterval = window.setInterval(() => {
      this.cleanupExpiredTabs();
    }, 60000);
  }
  
  private cleanupExpiredTabs(): void {
    const tabs = this.getActiveTabs();
    const now = Date.now();
    let cleaned = 0;
    
    Object.keys(tabs).forEach(tabKey => {
      if (now - tabs[tabKey].lastSeen > TabManager.TAB_TIMEOUT) {
        delete tabs[tabKey];
        cleaned++;
      }
    });
    
    if (cleaned > 0) {
      this.saveActiveTabs(tabs);
      console.log(`ğŸ—‘ï¸ Cleaned up ${cleaned} expired tabs`);
    }
  }
  
  private setupBeforeUnloadHandler(): void {
    window.addEventListener('beforeunload', () => {
      // é¡µé¢å¸è½½æ—¶æ¸…ç†å½“å‰æ ‡ç­¾é¡µè®°å½•
      const tabs = this.getActiveTabs();
      Object.keys(tabs).forEach(tabKey => {
        if (tabs[tabKey].tabId === this.currentTabId) {
          delete tabs[tabKey];
        }
      });
      this.saveActiveTabs(tabs);
    });
  }
  
  // ==================== è°ƒè¯•æ–¹æ³• ====================
  
  /**
   * è·å–æ‰€æœ‰æ´»è·ƒæ ‡ç­¾é¡µä¿¡æ¯ï¼ˆè°ƒè¯•ç”¨ï¼‰
   */
  getDebugInfo(): { tabs: Record<string, TabInfo>; currentTabId: string } {
    return {
      tabs: this.getActiveTabs(),
      currentTabId: this.currentTabId
    };
  }
  
  /**
   * æ¸…ç†æ‰€æœ‰æ ‡ç­¾é¡µè®°å½•ï¼ˆè°ƒè¯•ç”¨ï¼‰
   */
  clearAllTabs(): void {
    localStorage.removeItem(TabManager.STORAGE_KEY);
    localStorage.removeItem(TabManager.WAKEUP_SIGNAL_KEY);
    localStorage.removeItem(TabManager.WAKEUP_RESPONSE_KEY);
    console.log('ğŸ—‘ï¸ All tab records cleared');
  }
}

// å¯¼å‡ºå•ä¾‹å®ä¾‹
export const tabManager = TabManager.getInstance();
```

#### 2. `frontend/src/utils/smartNavigationV4.ts` (æ–°ç‰ˆæ™ºèƒ½å¯¼èˆª)
```typescript
/**
 * æ–¹æ¡ˆ4ï¼šåŸºäº localStorage çš„æ™ºèƒ½å¯¼èˆª
 */

import { tabManager } from './tabManager';

export interface NavigationResult {
  action: 'awakened' | 'opened_new' | 'failed';
  success: boolean;
  message: string;
  windowRef?: Window | null;
}

/**
 * æ™ºèƒ½å¯¼èˆªä¸»å‡½æ•°
 */
export async function smartNavigateV4(
  url: string, 
  agentId: string, 
  sessionId: string
): Promise<NavigationResult> {
  
  console.log(`ğŸ§  Smart navigation: ${agentId}/${sessionId} -> ${url}`);
  
  try {
    // 1. æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒçš„æ ‡ç­¾é¡µ
    const hasActiveTab = tabManager.hasActiveTab(agentId, sessionId);
    
    if (hasActiveTab) {
      console.log(`ğŸ” Found active tab for session: ${sessionId}`);
      
      // 2. å°è¯•å”¤èµ·å·²å­˜åœ¨çš„æ ‡ç­¾é¡µ
      const awakened = await tabManager.wakeupExistingTab(agentId, sessionId, url);
      
      if (awakened) {
        return {
          action: 'awakened',
          success: true,
          message: `æˆåŠŸå”¤èµ·å·²å­˜åœ¨çš„ä¼šè¯æ ‡ç­¾é¡µ`
        };
      } else {
        console.log(`âš ï¸ Failed to wake up existing tab, opening new one`);
      }
    }
    
    // 3. æ‰“å¼€æ–°æ ‡ç­¾é¡µ
    const windowName = getWindowName(agentId, sessionId);
    const newWindow = window.open(url, windowName);
    
    if (newWindow) {
      console.log(`ğŸ†• Opened new tab for session: ${sessionId}`);
      return {
        action: 'opened_new',
        success: true,
        message: `æ‰“å¼€æ–°çš„ä¼šè¯æ ‡ç­¾é¡µ`,
        windowRef: newWindow
      };
    } else {
      // å¯èƒ½è¢«å¼¹çª—é˜»æ­¢ï¼Œé™çº§åˆ°å½“å‰é¡µé¢å¯¼èˆª
      console.log(`ğŸš« Popup blocked, navigating in current tab`);
      window.location.href = url;
      return {
        action: 'opened_new',
        success: true,
        message: `åœ¨å½“å‰æ ‡ç­¾é¡µæ‰“å¼€ä¼šè¯`
      };
    }
    
  } catch (error) {
    console.error('Smart navigation failed:', error);
    
    // é™çº§å¤„ç†
    try {
      window.open(url) || (window.location.href = url);
      return {
        action: 'failed',
        success: false,
        message: `æ™ºèƒ½å¯¼èˆªå¤±è´¥ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ`
      };
    } catch (fallbackError) {
      console.error('Fallback navigation also failed:', fallbackError);
      return {
        action: 'failed',
        success: false,
        message: `å¯¼èˆªå¤±è´¥`
      };
    }
  }
}

/**
 * ç”Ÿæˆçª—å£åç§°
 */
export function getWindowName(agentId: string, sessionId: string): string {
  return `chat_${agentId}_${sessionId}`;
}

/**
 * ä»URLè§£æä¼šè¯ä¿¡æ¯
 */
export function parseSessionFromUrl(url: string): { agentId: string; sessionId: string } | null {
  try {
    const urlObj = new URL(url);
    const pathParts = urlObj.pathname.split('/');
    const chatIndex = pathParts.indexOf('chat');
    
    if (chatIndex !== -1 && pathParts[chatIndex + 1]) {
      const agentId = pathParts[chatIndex + 1];
      const sessionId = urlObj.searchParams.get('session');
      
      if (agentId && sessionId) {
        return { agentId, sessionId };
      }
    }
    
    return null;
  } catch (e) {
    console.error('Error parsing session from URL:', e);
    return null;
  }
}

/**
 * æ˜¾ç¤ºç”¨æˆ·é€šçŸ¥
 */
export function showNavigationNotification(result: NavigationResult): void {
  // å¯ä»¥é›†æˆåˆ°ç°æœ‰çš„é€šçŸ¥ç³»ç»Ÿ
  console.log(`ğŸ“¢ ${result.message}`);
  
  // å¦‚æœæœ‰ toast ç»„ä»¶ï¼Œå¯ä»¥è¿™æ ·è°ƒç”¨ï¼š
  // toast.success(result.message);
}
```

### ä¿®æ”¹ç°æœ‰æ–‡ä»¶

#### 3. ä¿®æ”¹ `frontend/src/components/SessionsDashboard.tsx`
```typescript
// åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥
import { smartNavigateV4, showNavigationNotification } from '../utils/smartNavigationV4';

// æ›¿æ¢ç°æœ‰çš„ handleOpenChat å‡½æ•°
const handleOpenChat = async (session: SessionInfo) => {
  const url = `/chat/${session.agentId}?session=${session.sessionId}${session.projectPath ? `&project=${encodeURIComponent(session.projectPath)}` : ''}`;
  
  try {
    const result = await smartNavigateV4(url, session.agentId, session.sessionId);
    
    // æ˜¾ç¤ºæ“ä½œç»“æœ
    showNavigationNotification(result);
    
    // è®°å½•è¯¦ç»†æ—¥å¿—
    console.log(`ğŸ¯ Navigation result:`, result);
    
  } catch (error) {
    console.error('Navigation failed:', error);
    // é™çº§ï¼šç›´æ¥æ‰“å¼€é“¾æ¥
    window.open(url);
  }
};
```

#### 4. ä¿®æ”¹èŠå¤©é¡µé¢ç»„ä»¶
éœ€è¦åœ¨æ‰€æœ‰èŠå¤©é¡µé¢ï¼ˆChatPageã€AgentChatPanelç­‰ï¼‰ä¸­æ·»åŠ è‡ªåŠ¨æ³¨å†Œé€»è¾‘ï¼š

```typescript
// åœ¨ ChatPage.tsx æˆ– AgentChatPanel.tsx ä¸­æ·»åŠ 
import { tabManager } from '../utils/tabManager';
import { parseSessionFromUrl } from '../utils/smartNavigationV4';

// åœ¨ç»„ä»¶ä¸­æ·»åŠ  useEffect
useEffect(() => {
  // è§£æå½“å‰URLè·å–ä¼šè¯ä¿¡æ¯
  const sessionInfo = parseSessionFromUrl(window.location.href);
  
  if (sessionInfo) {
    const { agentId, sessionId } = sessionInfo;
    
    // æ³¨å†Œå½“å‰æ ‡ç­¾é¡µ
    tabManager.registerCurrentTab(agentId, sessionId);
    
    // è®¾ç½®å”¤èµ·ç›‘å¬å™¨
    const cleanup = tabManager.setupWakeupListener(agentId, sessionId);
    
    // å®šæœŸæ›´æ–°æ´»è·ƒçŠ¶æ€ï¼ˆä¸å¿ƒè·³ä¸€èµ·ï¼‰
    const updateActivity = () => {
      tabManager.updateCurrentTabActivity(agentId, sessionId);
    };
    
    const activityInterval = setInterval(updateActivity, 30000); // 30ç§’
    
    // é¡µé¢ç„¦ç‚¹å˜åŒ–æ—¶æ›´æ–°æ´»è·ƒçŠ¶æ€
    const handleFocus = () => updateActivity();
    const handleVisibilityChange = () => {
      if (!document.hidden) updateActivity();
    };
    
    window.addEventListener('focus', handleFocus);
    document.addEventListener('visibilitychange', handleVisibilityChange);
    
    // æ¸…ç†å‡½æ•°
    return () => {
      cleanup();
      clearInterval(activityInterval);
      window.removeEventListener('focus', handleFocus);
      document.removeEventListener('visibilitychange', handleVisibilityChange);
    };
  }
}, [agent.id, currentSessionId]); // ä¾èµ–äºå®é™…çš„ agentId å’Œ sessionId
```

#### 5. ä¸å¿ƒè·³æœºåˆ¶é›†æˆ
ä¿®æ”¹ `frontend/src/hooks/useSessionHeartbeat.ts`ï¼š

```typescript
// åœ¨å¿ƒè·³å‘é€çš„åŒæ—¶æ›´æ–°æ ‡ç­¾é¡µæ´»è·ƒçŠ¶æ€
import { tabManager } from '../utils/tabManager';

// åœ¨ sendHeartbeat å‡½æ•°ä¸­æ·»åŠ 
const sendHeartbeat = useCallback(async () => {
  // ... ç°æœ‰çš„å¿ƒè·³é€»è¾‘
  
  // åŒæ—¶æ›´æ–°æ ‡ç­¾é¡µæ´»è·ƒçŠ¶æ€
  if (agentId && sessionId) {
    tabManager.updateCurrentTabActivity(agentId, sessionId);
  }
  
  // ... ç°æœ‰çš„å¿ƒè·³é€»è¾‘
}, [agentId, sessionId, projectPath, enabled]);
```

## ğŸ­ ç”¨æˆ·åœºæ™¯è¦†ç›–

### åœºæ™¯1ï¼šä»ªè¡¨æ¿æ°”æ³¡ç‚¹å‡» âœ…
```
ç”¨æˆ·æ“ä½œ: ä»ªè¡¨æ¿ â†’ ç‚¹å‡»ä¼šè¯Aæ°”æ³¡
ç³»ç»Ÿå¤„ç†: 
1. smartNavigateV4() æ£€æŸ¥å·²å­˜åœ¨æ ‡ç­¾é¡µ
2. å‘ç°æœ‰æ´»è·ƒæ ‡ç­¾é¡µ â†’ å‘é€å”¤èµ·ä¿¡å·
3. ç›®æ ‡æ ‡ç­¾é¡µå“åº” â†’ window.focus() + æ ‡é¢˜é—ªçƒ
4. ç”¨æˆ·çœ‹åˆ°æ ‡ç­¾é¡µåˆ‡æ¢åˆ°å‰å°

ç»“æœ: âœ… æ™ºèƒ½å”¤èµ·ç°æœ‰æ ‡ç­¾é¡µ
```

### åœºæ™¯2ï¼šç›´æ¥URLè¾“å…¥ âœ…
```
ç”¨æˆ·æ“ä½œ: åœ°å€æ è¾“å…¥ /chat/general-chat?session=xxx
ç³»ç»Ÿå¤„ç†:
1. ChatPage åŠ è½½ â†’ useEffect è§¦å‘
2. parseSessionFromUrl() è§£æä¼šè¯ä¿¡æ¯
3. tabManager.registerCurrentTab() æ³¨å†Œæ ‡ç­¾é¡µ
4. è®¾ç½®å”¤èµ·ç›‘å¬å™¨

ç»“æœ: âœ… æ ‡ç­¾é¡µè¢«æ­£ç¡®æ³¨å†Œï¼Œåç»­æ™ºèƒ½å¯¼èˆªç”Ÿæ•ˆ
```

### åœºæ™¯3ï¼šä¹¦ç­¾æ‰“å¼€ âœ…
```
ç”¨æˆ·æ“ä½œ: ç‚¹å‡»ä¹¦ç­¾ /chat/general-chat?session=xxx
ç³»ç»Ÿå¤„ç†: åŒåœºæ™¯2ï¼Œè‡ªåŠ¨æ³¨å†Œæœºåˆ¶ç”Ÿæ•ˆ

ç»“æœ: âœ… æ ‡ç­¾é¡µè¢«æ³¨å†Œå¹¶å¯è¢«æ™ºèƒ½å¯¼èˆª
```

### åœºæ™¯4ï¼šå¤–éƒ¨é“¾æ¥ âœ…
```
ç”¨æˆ·æ“ä½œ: ä»é‚®ä»¶/å…¶ä»–åº”ç”¨ç‚¹å‡»èŠå¤©é“¾æ¥
ç³»ç»Ÿå¤„ç†: åŒåœºæ™¯2ï¼Œé¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ³¨å†Œ

ç»“æœ: âœ… å¤–éƒ¨æ‰“å¼€çš„æ ‡ç­¾é¡µä¹Ÿè¢«çº³å…¥ç®¡ç†
```

### åœºæ™¯5ï¼šæ–°çª—å£æ‰“å¼€ âœ…
```
ç”¨æˆ·æ“ä½œ: å³é”® â†’ "åœ¨æ–°çª—å£ä¸­æ‰“å¼€"
ç³»ç»Ÿå¤„ç†: åŒåœºæ™¯2ï¼Œæ¯ä¸ªçª—å£ç‹¬ç«‹ç®¡ç†

ç»“æœ: âœ… æ–°çª—å£æ ‡ç­¾é¡µæ­£å¸¸å·¥ä½œ
```

### åœºæ™¯6ï¼šæ··åˆåœºæ™¯ âœ…
```
æ—¶é—´çº¿:
T1: ç”¨æˆ·ç›´æ¥URLæ‰“å¼€ä¼šè¯A â†’ æ ‡ç­¾é¡µ1æ³¨å†Œ
T2: ç”¨æˆ·åœ¨ä»ªè¡¨æ¿ç‚¹å‡»ä¼šè¯Aæ°”æ³¡ â†’ å”¤èµ·æ ‡ç­¾é¡µ1 âœ…
T3: ç”¨æˆ·é€šè¿‡æ°”æ³¡æ‰“å¼€ä¼šè¯B â†’ æ–°æ ‡ç­¾é¡µ2
T4: ç”¨æˆ·ç›´æ¥URLæ‰“å¼€ä¼šè¯B â†’ å”¤èµ·æ ‡ç­¾é¡µ2 âœ…

ç»“æœ: âœ… å®Œç¾çš„æ™ºèƒ½ç®¡ç†
```

## ğŸ¨ ç”¨æˆ·ä½“éªŒæ•ˆæœ

### è§†è§‰æ•ˆæœ
1. **æ ‡ç­¾é¡µåˆ‡æ¢**: ç›®æ ‡æ ‡ç­¾é¡µè‡ªåŠ¨åˆ‡æ¢åˆ°å‰å°
2. **æ ‡é¢˜é—ªçƒ**: `ğŸ”” ä¼šè¯å·²å”¤èµ·` â†” `åŸæ ‡é¢˜` (é—ªçƒ3æ¬¡)
3. **èšç„¦æç¤º**: é¡µé¢è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°å†…å®¹ï¼ˆå¯é€‰ï¼‰

### éŸ³é¢‘æ•ˆæœ
1. **æç¤ºéŸ³**: è½»å¾®çš„"å®"å£°æç¤º
2. **éŸ³é‡æ§åˆ¶**: 30%éŸ³é‡ï¼Œä¸æ‰“æ‰°ç”¨æˆ·

### äº¤äº’åé¦ˆ
1. **æˆåŠŸæç¤º**: "æˆåŠŸå”¤èµ·å·²å­˜åœ¨çš„ä¼šè¯æ ‡ç­¾é¡µ"
2. **æ–°å¼€æç¤º**: "æ‰“å¼€æ–°çš„ä¼šè¯æ ‡ç­¾é¡µ"
3. **å¤±è´¥é™çº§**: "æ™ºèƒ½å¯¼èˆªå¤±è´¥ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ"

## âš¡ æ€§èƒ½å’Œå¯é æ€§

### å­˜å‚¨ç®¡ç†
- **è‡ªåŠ¨æ¸…ç†**: 5åˆ†é’Ÿæ— æ´»åŠ¨çš„æ ‡ç­¾é¡µè‡ªåŠ¨æ¸…ç†
- **å­˜å‚¨å¤§å°**: æ¯ä¸ªæ ‡ç­¾é¡µ ~200å­—èŠ‚ï¼Œ100ä¸ªæ ‡ç­¾é¡µ ~20KB
- **æ¸…ç†é¢‘ç‡**: æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡è¿‡æœŸè®°å½•

### é”™è¯¯å¤„ç†
- **localStorage å¼‚å¸¸**: é™çº§åˆ°æ™®é€šå¯¼èˆª
- **JSON è§£æé”™è¯¯**: å¿½ç•¥é”™è¯¯æ•°æ®ï¼Œé‡æ–°å¼€å§‹
- **å”¤èµ·è¶…æ—¶**: 2ç§’è¶…æ—¶åæ‰“å¼€æ–°æ ‡ç­¾é¡µ
- **æƒé™é™åˆ¶**: window.focus() å¤±è´¥æ—¶ä»æœ‰è§†è§‰æç¤º

### å…¼å®¹æ€§
- **ç°ä»£æµè§ˆå™¨**: 100% æ”¯æŒ
- **IE11**: éƒ¨åˆ†æ”¯æŒï¼ˆæ—  BroadcastChannelï¼Œä½† localStorage å¯ç”¨ï¼‰
- **ç§»åŠ¨ç«¯**: åŸºæœ¬æ”¯æŒï¼ˆwindow.focus() æ•ˆæœæœ‰é™ï¼‰

## ğŸ”§ è°ƒè¯•å’Œç»´æŠ¤

### è°ƒè¯•å·¥å…·
```javascript
// æµè§ˆå™¨æ§åˆ¶å°ä¸­å¯ç”¨çš„è°ƒè¯•å‘½ä»¤
window.tabManagerDebug = {
  // æŸ¥çœ‹æ‰€æœ‰æ´»è·ƒæ ‡ç­¾é¡µ
  showTabs: () => console.table(tabManager.getDebugInfo().tabs),
  
  // æ¸…ç†æ‰€æœ‰è®°å½•
  clearAll: () => tabManager.clearAllTabs(),
  
  // æ‰‹åŠ¨å”¤èµ·æµ‹è¯•
  testWakeup: (agentId, sessionId) => tabManager.wakeupExistingTab(agentId, sessionId),
  
  // æŸ¥çœ‹å½“å‰æ ‡ç­¾é¡µID
  getCurrentTabId: () => tabManager.getDebugInfo().currentTabId
};
```

### ç›‘æ§æŒ‡æ ‡
- å”¤èµ·æˆåŠŸç‡
- æ ‡ç­¾é¡µæ³¨å†Œæ•°é‡
- æ¸…ç†çš„è¿‡æœŸè®°å½•æ•°
- é”™è¯¯å‘ç”Ÿé¢‘ç‡

## ğŸ“Š å®æ–½è¯„ä¼°

### å¼€å‘å·¥ä½œé‡
- **æ–°å¢ä»£ç **: ~800è¡Œ
- **ä¿®æ”¹ä»£ç **: ~200è¡Œ
- **æµ‹è¯•è¦†ç›–**: 15ä¸ªåœºæ™¯
- **å¼€å‘æ—¶é—´**: 2-3å¤©

### é£é™©è¯„ä¼°
- **æŠ€æœ¯é£é™©**: ä½ï¼ˆåŸºäºæˆç†Ÿçš„ localStorage APIï¼‰
- **å…¼å®¹æ€§é£é™©**: ä½ï¼ˆå¹¿æ³›çš„æµè§ˆå™¨æ”¯æŒï¼‰
- **æ€§èƒ½é£é™©**: ä½ï¼ˆè½»é‡çº§å®ç°ï¼‰
- **ç»´æŠ¤é£é™©**: ä½ï¼ˆä»£ç ç®€æ´ï¼Œé€»è¾‘æ¸…æ™°ï¼‰

è¿™ä¸ªå®Œæ•´çš„æ–¹æ¡ˆ4è®¾è®¡èƒ½å¤Ÿä»¥æœ€å°çš„å¤æ‚åº¦å®ç°æ™ºèƒ½æ ‡ç­¾é¡µç®¡ç†ï¼Œè¦†ç›–æ‰€æœ‰å¸¸è§çš„URLæ‰“å¼€æ–¹å¼ï¼Œå¹¶æä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒï¼æ‚¨è§‰å¾—è¿™ä¸ªè®¾è®¡å¦‚ä½•ï¼Ÿ
